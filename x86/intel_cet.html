

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>14. Control-flow Enforcement Technology (CET) &mdash; The Linux-Next Dragon Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="15. Linux IOMMU Support" href="intel-iommu.html" />
    <link rel="prev" title="13. PAT (Page Attribute Table)" href="pat.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux-Next Dragon Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.12.15-dragon
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">x86-specific Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="boot.html">1. The Linux/x86 Boot Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="booting-dt.html">2. DeviceTree Booting</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpuinfo.html">3. x86 Feature Flags</a></li>
<li class="toctree-l2"><a class="reference internal" href="topology.html">4. x86 Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="exception-tables.html">5. Kernel level exception handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-stacks.html">6. Kernel Stacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="entry_64.html">7. Kernel Entries</a></li>
<li class="toctree-l2"><a class="reference internal" href="earlyprintk.html">8. Early Printk</a></li>
<li class="toctree-l2"><a class="reference internal" href="orc-unwinder.html">9. ORC unwinder</a></li>
<li class="toctree-l2"><a class="reference internal" href="zero-page.html">10. Zero Page</a></li>
<li class="toctree-l2"><a class="reference internal" href="tlb.html">11. The TLB</a></li>
<li class="toctree-l2"><a class="reference internal" href="mtrr.html">12. MTRR (Memory Type Range Register) control</a></li>
<li class="toctree-l2"><a class="reference internal" href="pat.html">13. PAT (Page Attribute Table)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">14. Control-flow Enforcement Technology (CET)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">14.1. [1] Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#application-enabling">14.2. [2] Application Enabling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backward-compatibility">14.3. [3] Backward Compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cet-arch-prctl-s">14.4. [4] CET arch_prctl()’s</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-implementation-of-the-shadow-stack">14.5. [5] The implementation of the Shadow Stack</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#shadow-stack-size">14.5.1. Shadow Stack size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#signal">14.5.2. Signal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fork">14.5.3. Fork</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="intel-iommu.html">15. Linux IOMMU Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel_txt.html">16. Intel(R) TXT Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="amd-memory-encryption.html">17. AMD Memory Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="pti.html">18. Page Table Isolation (PTI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mds.html">19. Microarchitectural Data Sampling (MDS) mitigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="microcode.html">20. The Linux Microcode Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="resctrl.html">21. User Interface for Resource Control feature</a></li>
<li class="toctree-l2"><a class="reference internal" href="tsx_async_abort.html">22. TSX Async Abort (TAA) mitigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-legacy-support.html">23. USB Legacy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="i386/index.html">24. i386 Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="x86_64/index.html">25. x86_64 Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="sva.html">26. Shared Virtual Addressing (SVA) with ENQCMD</a></li>
<li class="toctree-l2"><a class="reference internal" href="sgx.html">27. Software Guard eXtensions (SGX)</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html">28. Feature status on x86 architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux-Next Dragon Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">x86-specific Documentation</a> &raquo;</li>
        
      <li><span class="section-number">14. </span>Control-flow Enforcement Technology (CET)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/x86/intel_cet.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="control-flow-enforcement-technology-cet">
<h1><span class="section-number">14. </span>Control-flow Enforcement Technology (CET)<a class="headerlink" href="#control-flow-enforcement-technology-cet" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2><span class="section-number">14.1. </span>[1] Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Control-flow Enforcement Technology (CET) is an Intel processor feature
that provides protection against return/jump-oriented programming (ROP)
attacks.  It can be set up to protect both applications and the kernel.
Only user-mode protection is implemented in the 64-bit kernel, including
support for running legacy 32-bit applications.</p>
<p>CET introduces Shadow Stack and Indirect Branch Tracking.  Shadow stack is
a secondary stack allocated from memory and cannot be directly modified by
applications.  When executing a CALL instruction, the processor pushes the
return address to both the normal stack and the shadow stack.  Upon
function return, the processor pops the shadow stack copy and compares it
to the normal stack copy.  If the two differ, the processor raises a
control-protection fault.  Indirect branch tracking verifies indirect
CALL/JMP targets are intended as marked by the compiler with ‘ENDBR’
opcodes.</p>
<p>There is a Kconfig option:</p>
<blockquote>
<div><p>X86_CET.</p>
</div></blockquote>
<p>To build a CET-enabled kernel, Binutils v2.31 and GCC v8.1 or LLVM v10.0.1
or later are required.  To build a CET-enabled application, GLIBC v2.28 or
later is also required.</p>
<p>There are two command-line options for disabling CET features:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>no_user_shstk - disables user shadow stack, and
no_user_ibt   - disables user indirect branch tracking.
</pre></div>
</div>
<p>At run time, /proc/cpuinfo shows CET features if the processor supports
CET.</p>
</div>
<div class="section" id="application-enabling">
<h2><span class="section-number">14.2. </span>[2] Application Enabling<a class="headerlink" href="#application-enabling" title="Permalink to this headline">¶</a></h2>
<p>An application’s CET capability is marked in its ELF header and can be
verified from readelf/llvm-readelf output:</p>
<blockquote>
<div><dl class="simple">
<dt>readelf -n &lt;application&gt; | grep -a SHSTK</dt><dd><p>properties: x86 feature: IBT, SHSTK</p>
</dd>
</dl>
</div></blockquote>
<p>If an application supports CET and is statically linked, it will run with
CET protection.  If the application needs any shared libraries, the loader
checks all dependencies and enables CET when all requirements are met.</p>
</div>
<div class="section" id="backward-compatibility">
<h2><span class="section-number">14.3. </span>[3] Backward Compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this headline">¶</a></h2>
<p>GLIBC provides a few CET tunables via the GLIBC_TUNABLES environment
variable:</p>
<dl>
<dt>GLIBC_TUNABLES=glibc.tune.hwcaps=-SHSTK,-IBT</dt><dd><p>Turn off SHSTK/IBT.</p>
</dd>
<dt>GLIBC_TUNABLES=glibc.tune.x86_shstk=&lt;on, permissive&gt;</dt><dd><p>This controls how dlopen() handles SHSTK legacy libraries:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>on         - continue with SHSTK enabled;
permissive - continue with SHSTK off.
</pre></div>
</div>
</dd>
</dl>
<p>Details can be found in the GLIBC manual pages.</p>
</div>
<div class="section" id="cet-arch-prctl-s">
<h2><span class="section-number">14.4. </span>[4] CET arch_prctl()’s<a class="headerlink" href="#cet-arch-prctl-s" title="Permalink to this headline">¶</a></h2>
<p>Several arch_prctl()’s have been added for CET:</p>
<dl>
<dt>arch_prctl(ARCH_X86_CET_STATUS, u64 <a href="#id1"><span class="problematic" id="id2">*</span></a>addr)</dt><dd><p>Return CET feature status.</p>
<p>The parameter ‘addr’ is a pointer to a user buffer.
On returning to the caller, the kernel fills the following
information:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*addr       = shadow stack/indirect branch tracking status
*(addr + 1) = shadow stack base address
*(addr + 2) = shadow stack size
</pre></div>
</div>
</dd>
<dt>arch_prctl(ARCH_X86_CET_DISABLE, unsigned int features)</dt><dd><p>Disable shadow stack and/or indirect branch tracking as specified in
‘features’.  Return -EPERM if CET is locked.</p>
</dd>
<dt>arch_prctl(ARCH_X86_CET_LOCK)</dt><dd><p>Lock in all CET features.  They cannot be turned off afterwards.</p>
</dd>
<dt>Note:</dt><dd><p>There is no CET-enabling arch_prctl function.  By design, CET is enabled
automatically if the binary and the system can support it.</p>
</dd>
</dl>
</div>
<div class="section" id="the-implementation-of-the-shadow-stack">
<h2><span class="section-number">14.5. </span>[5] The implementation of the Shadow Stack<a class="headerlink" href="#the-implementation-of-the-shadow-stack" title="Permalink to this headline">¶</a></h2>
<div class="section" id="shadow-stack-size">
<h3><span class="section-number">14.5.1. </span>Shadow Stack size<a class="headerlink" href="#shadow-stack-size" title="Permalink to this headline">¶</a></h3>
<p>A task’s shadow stack is allocated from memory to a fixed size of
MIN(RLIMIT_STACK, 4 GB).  In other words, the shadow stack is allocated to
the maximum size of the normal stack, but capped to 4 GB.  However,
a compat-mode application’s address space is smaller, each of its thread’s
shadow stack size is MIN(1/4 RLIMIT_STACK, 4 GB).</p>
</div>
<div class="section" id="signal">
<h3><span class="section-number">14.5.2. </span>Signal<a class="headerlink" href="#signal" title="Permalink to this headline">¶</a></h3>
<p>The main program and its signal handlers use the same shadow stack.
Because the shadow stack stores only return addresses, a large shadow
stack covers the condition that both the program stack and the signal
alternate stack run out.</p>
<p>The kernel creates a restore token for the shadow stack restoring address
and verifies that token when restoring from the signal handler.</p>
</div>
<div class="section" id="fork">
<h3><span class="section-number">14.5.3. </span>Fork<a class="headerlink" href="#fork" title="Permalink to this headline">¶</a></h3>
<p>The shadow stack’s vma has VM_SHSTK flag set; its PTEs are required to be
read-only and dirty.  When a shadow stack PTE is not RO and dirty, a
shadow access triggers a page fault with the shadow stack access bit set
in the page fault error code.</p>
<p>When a task forks a child, its shadow stack PTEs are copied and both the
parent’s and the child’s shadow stack PTEs are cleared of the dirty bit.
Upon the next shadow stack access, the resulting shadow stack page fault
is handled by page copy/re-use.</p>
<p>When a pthread child is created, the kernel allocates a new shadow stack
for the new thread.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="intel-iommu.html" class="btn btn-neutral float-right" title="15. Linux IOMMU Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="pat.html" class="btn btn-neutral float-left" title="13. PAT (Page Attribute Table)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>