

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Core Scheduling &mdash; The Linux-Next Dragon Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux-Next Dragon Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.11.20-dragon
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux-Next Dragon Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Core Scheduling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/admin-guide/hw-vuln/core-scheduling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="core-scheduling">
<h1>Core Scheduling<a class="headerlink" href="#core-scheduling" title="Permalink to this headline">¶</a></h1>
<p>Core scheduling support allows userspace to define groups of tasks that can
share a core. These groups can be specified either for security usecases (one
group of tasks don’t trust another), or for performance usecases (some
workloads may benefit from running on the same core as they don’t need the same
hardware resources of the shared core).</p>
<div class="section" id="security-usecase">
<h2>Security usecase<a class="headerlink" href="#security-usecase" title="Permalink to this headline">¶</a></h2>
<p>A cross-HT attack involves the attacker and victim running on different
Hyper Threads of the same core. MDS and L1TF are examples of such attacks.
Without core scheduling, the only full mitigation of cross-HT attacks is to
disable Hyper Threading (HT). Core scheduling allows HT to be turned on safely
by ensuring that trusted tasks can share a core. This increase in core sharing
can improvement performance, however it is not guaranteed that performance will
always improve, though that is seen to be the case with a number of real world
workloads. In theory, core scheduling aims to perform at least as good as when
Hyper Threading is disabled. In practice, this is mostly the case though not
always: as synchronizing scheduling decisions across 2 or more CPUs in a core
involves additional overhead - especially when the system is lightly loaded
(<code class="docutils literal notranslate"><span class="pre">total_threads</span> <span class="pre">&lt;=</span> <span class="pre">N/2</span></code>, where N is the total number of CPUs).</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Core scheduling support is enabled via the <code class="docutils literal notranslate"><span class="pre">CONFIG_SCHED_CORE</span></code> config option.
Using this feature, userspace defines groups of tasks that can be co-scheduled
on the same core.
The core scheduler uses this information to make sure that tasks that are not
in the same group never run simultaneously on a core, while doing its best to
satisfy the system’s scheduling requirements.</p>
<p>There are 2 ways to use core-scheduling:</p>
<div class="section" id="cgroup">
<h3>CGroup<a class="headerlink" href="#cgroup" title="Permalink to this headline">¶</a></h3>
<p>Core scheduling adds additional files to the CPU controller CGroup:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cpu.core_tag</span></code></p></li>
</ul>
<p>Writing <code class="docutils literal notranslate"><span class="pre">1</span></code> into this file results in all tasks in the group getting tagged.
This results in all the CGroup’s tasks allowed to run concurrently on a core’s
hyperthreads (also called siblings).</p>
<p>The file being a value of <code class="docutils literal notranslate"><span class="pre">0</span></code> means the tag state of the CGroup is inherited
from its parent hierarchy. If any ancestor of the CGroup is tagged, then the
group is tagged.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Once a CGroup is tagged via cpu.core_tag, it is not possible to set this
for any descendant of the tagged group.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When a CGroup is not tagged, all the tasks within the group can share
a core with kernel threads and untagged system threads. For this reason,
if a group has <code class="docutils literal notranslate"><span class="pre">cpu.core_tag</span></code> of 0, it is considered to be trusted.</p>
</div>
</div>
<div class="section" id="prctl-interface">
<h3>prctl interface<a class="headerlink" href="#prctl-interface" title="Permalink to this headline">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">prtcl(2)</span></code> command <code class="docutils literal notranslate"><span class="pre">PR_SCHED_CORE_SHARE</span></code> provides an interface for the
creation of and admission and removal of tasks from core scheduling groups.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;sys/prctl.h&gt;

int prctl(int option, unsigned long arg2, unsigned long arg3,
        unsigned long arg4, unsigned long arg5);
</pre></div>
</div>
<dl class="simple">
<dt>option:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">PR_SCHED_CORE_SHARE</span></code></p>
</dd>
<dt>arg2:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PR_SCHED_CORE_CLEAR</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">0</span>&#160; <span class="pre">--</span> <span class="pre">clear</span> <span class="pre">core_sched</span> <span class="pre">cookie</span> <span class="pre">of</span> <span class="pre">pid</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PR_SCHED_CORE_SHARE_FROM</span>&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">1</span>&#160; <span class="pre">--</span> <span class="pre">get</span> <span class="pre">core_sched</span> <span class="pre">cookie</span> <span class="pre">from</span> <span class="pre">pid</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PR_SCHED_CORE_SHARE_TO</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">2</span>&#160; <span class="pre">--</span> <span class="pre">push</span> <span class="pre">core_sched</span> <span class="pre">cookie</span> <span class="pre">to</span> <span class="pre">pid</span></code></p></li>
</ul>
</dd>
<dt>arg3:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">tid</span></code> of the task for which the operation applies</p>
</dd>
<dt>arg4 and arg5:</dt><dd><p>MUST be equal to 0.</p>
</dd>
</dl>
<div class="section" id="creation">
<h4>Creation<a class="headerlink" href="#creation" title="Permalink to this headline">¶</a></h4>
<p>Creation is accomplished by sharing a ‘’cookie’’ from a process not currently in
a core scheduling group.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (prctl(PR_SCHED_CORE_SHARE, PR_SCHED_CORE_SHARE_FROM, src_tid, 0, 0) &lt; 0)
        handle_error(&quot;src_tid sched_core failed&quot;);
</pre></div>
</div>
</div>
<div class="section" id="removal">
<h4>Removal<a class="headerlink" href="#removal" title="Permalink to this headline">¶</a></h4>
<p>Removing a task from a core scheduling group is done by:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (prctl(PR_SCHED_CORE_SHARE, PR_SCHED_CORE_SHARE_CLEAR, clr_tid, 0, 0) &lt; 0)
         handle_error(&quot;clr_tid sched_core failed&quot;);
</pre></div>
</div>
</div>
<div class="section" id="cookie-transferal">
<h4>Cookie Transferal<a class="headerlink" href="#cookie-transferal" title="Permalink to this headline">¶</a></h4>
<p>Transferring a cookie between the current and other tasks is possible using
PR_SCHED_CORE_SHARE_FROM and PR_SCHED_CORE_SHARE_TO to inherit a cookie from a
specified task or a share a cookie with a task. In combination this allows a
simple helper program to pull a cookie from a task in an existing core
scheduling group and share it with already running tasks.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (prctl(PR_SCHED_CORE_SHARE, PR_SCHED_CORE_SHARE_FROM, from_tid, 0, 0) &lt; 0)
        handle_error(&quot;from_tid sched_core failed&quot;);

if (prctl(PR_SCHED_CORE_SHARE, PR_SCHED_CORE_SHARE_TO, to_tid, 0, 0) &lt; 0)
        handle_error(&quot;to_tid sched_core failed&quot;);
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The core-sharing granted with <code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code> will be subject to
core-sharing restrictions specified by the CGroup interface. For example,
if tasks T1 and T2 are a part of 2 different tagged CGroups, then they will
not share a core even if <code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code> is called. This is analogous to how
affinities are set using the cpuset interface.</p>
</div>
<p>It is important to note that, on a <code class="docutils literal notranslate"><span class="pre">clone(2)</span></code> syscall with <code class="docutils literal notranslate"><span class="pre">CLONE_THREAD</span></code> set,
the child will be assigned the same ‘’cookie’’ as its parent and thus in the
same core scheduling group.  In the security usecase, a <code class="docutils literal notranslate"><span class="pre">CLONE_THREAD</span></code> child
can access its parent’s address space anyway (<code class="docutils literal notranslate"><span class="pre">CLONE_THREAD</span></code> requires
<code class="docutils literal notranslate"><span class="pre">CLONE_SIGHAND</span></code> which requires <code class="docutils literal notranslate"><span class="pre">CLONE_VM</span></code>), so there’s no point in not
allowing them to share a core. If a different behavior is desired, the child
thread can call <code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code> as needed.  This behavior is specific to the
<code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code> interface. For the CGroup interface, the child of a fork always
shares a core with its parent.  On the other hand, if a parent was previously
tagged via <code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code> and does a regular <code class="docutils literal notranslate"><span class="pre">fork(2)</span></code> syscall, the child will
receive a unique tag.</p>
</div>
</div>
</div>
<div class="section" id="design-implementation">
<h2>Design/Implementation<a class="headerlink" href="#design-implementation" title="Permalink to this headline">¶</a></h2>
<p>Each task that is tagged is assigned a cookie internally in the kernel. As
mentioned in <a class="reference internal" href="#usage">Usage</a>, tasks with the same cookie value are assumed to trust
each other and share a core.</p>
<p>The basic idea is that, every schedule event tries to select tasks for all the
siblings of a core such that all the selected tasks running on a core are
trusted (same cookie) at any point in time. Kernel threads are assumed trusted.
The idle task is considered special, as it trusts everything and everything
trusts it.</p>
<p>During a schedule() event on any sibling of a core, the highest priority task on
the sibling’s core is picked and assigned to the sibling calling schedule(), if
the sibling has the task enqueued. For rest of the siblings in the core,
highest priority task with the same cookie is selected if there is one runnable
in their individual run queues. If a task with same cookie is not available,
the idle task is selected.  Idle task is globally trusted.</p>
<p>Once a task has been selected for all the siblings in the core, an IPI is sent to
siblings for whom a new task was selected. Siblings on receiving the IPI will
switch to the new task immediately. If an idle task is selected for a sibling,
then the sibling is considered to be in a <cite>forced idle</cite> state. I.e., it may
have tasks on its on runqueue to run, however it will still have to run idle.
More on this in the next section.</p>
</div>
<div class="section" id="forced-idling-of-tasks">
<h2>Forced-idling of tasks<a class="headerlink" href="#forced-idling-of-tasks" title="Permalink to this headline">¶</a></h2>
<p>The scheduler tries its best to find tasks that trust each other such that all
tasks selected to be scheduled are of the highest priority in a core.  However,
it is possible that some runqueues had tasks that were incompatible with the
highest priority ones in the core. Favoring security over fairness, one or more
siblings could be forced to select a lower priority task if the highest
priority task is not trusted with respect to the core wide highest priority
task.  If a sibling does not have a trusted task to run, it will be forced idle
by the scheduler (idle thread is scheduled to run).</p>
<p>When the highest priority task is selected to run, a reschedule-IPI is sent to
the sibling to force it into idle. This results in 4 cases which need to be
considered depending on whether a VM or a regular usermode process was running
on either HT:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>       HT1 (attack)            HT2 (victim)
A      idle -&gt; user space      user space -&gt; idle
B      idle -&gt; user space      guest -&gt; idle
C      idle -&gt; guest           user space -&gt; idle
D      idle -&gt; guest           guest -&gt; idle
</pre></div>
</div>
<p>Note that for better performance, we do not wait for the destination CPU
(victim) to enter idle mode. This is because the sending of the IPI would bring
the destination CPU immediately into kernel mode from user space, or VMEXIT
in the case of guests. At best, this would only leak some scheduler metadata
which may not be worth protecting. It is also possible that the IPI is received
too late on some architectures, but this has not been observed in the case of
x86.</p>
</div>
<div class="section" id="trust-model">
<h2>Trust model<a class="headerlink" href="#trust-model" title="Permalink to this headline">¶</a></h2>
<p>Core scheduling maintains trust relationships amongst groups of tasks by
assigning the tag of them with the same cookie value.
When a system with core scheduling boots, all tasks are considered to trust
each other. This is because the core scheduler does not have information about
trust relationships until userspace uses the above mentioned interfaces, to
communicate them. In other words, all tasks have a default cookie value of 0.
and are considered system-wide trusted. The stunning of siblings running
cookie-0 tasks is also avoided.</p>
<p>Once userspace uses the above mentioned interfaces to group sets of tasks, tasks
within such groups are considered to trust each other, but do not trust those
outside. Tasks outside the group also don’t trust tasks within.</p>
</div>
<div class="section" id="limitations-in-core-scheduling">
<h2>Limitations in core-scheduling<a class="headerlink" href="#limitations-in-core-scheduling" title="Permalink to this headline">¶</a></h2>
<p>Core scheduling tries to guarantee that only trusted tasks run concurrently on a
core. But there could be small window of time during which untrusted tasks run
concurrently or kernel could be running concurrently with a task not trusted by
kernel.</p>
<div class="section" id="ipi-processing-delays">
<h3>1. IPI processing delays<a class="headerlink" href="#ipi-processing-delays" title="Permalink to this headline">¶</a></h3>
<p>Core scheduling selects only trusted tasks to run together. IPI is used to notify
the siblings to switch to the new task. But there could be hardware delays in
receiving of the IPI on some arch (on x86, this has not been observed). This may
cause an attacker task to start running on a CPU before its siblings receive the
IPI. Even though cache is flushed on entry to user mode, victim tasks on siblings
may populate data in the cache and micro architectural buffers after the attacker
starts to run and this is a possibility for data leak.</p>
</div>
</div>
<div class="section" id="open-cross-ht-issues-that-core-scheduling-does-not-solve">
<h2>Open cross-HT issues that core scheduling does not solve<a class="headerlink" href="#open-cross-ht-issues-that-core-scheduling-does-not-solve" title="Permalink to this headline">¶</a></h2>
<div class="section" id="for-mds">
<h3>1. For MDS<a class="headerlink" href="#for-mds" title="Permalink to this headline">¶</a></h3>
<p>Core scheduling cannot protect against MDS attacks between an HT running in
user mode and another running in kernel mode. Even though both HTs run tasks
which trust each other, kernel memory is still considered untrusted. Such
attacks are possible for any combination of sibling CPU modes (host or guest mode).</p>
</div>
<div class="section" id="for-l1tf">
<h3>2. For L1TF<a class="headerlink" href="#for-l1tf" title="Permalink to this headline">¶</a></h3>
<p>Core scheduling cannot protect against an L1TF guest attacker exploiting a
guest or host victim. This is because the guest attacker can craft invalid
PTEs which are not inverted due to a vulnerable guest kernel. The only
solution is to disable EPT (Extended Page Tables).</p>
<p>For both MDS and L1TF, if the guest vCPU is configured to not trust each
other (by tagging separately), then the guest to guest attacks would go away.
Or it could be a system admin policy which considers guest to guest attacks as
a guest problem.</p>
<p>Another approach to resolve these would be to make every untrusted task on the
system to not trust every other untrusted task. While this could reduce
parallelism of the untrusted tasks, it would still solve the above issues while
allowing system processes (trusted tasks) to share a core.</p>
</div>
<div class="section" id="protecting-the-kernel-irq-syscall-vmexit">
<h3>3. Protecting the kernel (IRQ, syscall, VMEXIT)<a class="headerlink" href="#protecting-the-kernel-irq-syscall-vmexit" title="Permalink to this headline">¶</a></h3>
<p>This section is a work in progress. The main point here is entry into the
kernel is not protected from attackers on a sibling.</p>
</div>
</div>
<div class="section" id="use-cases">
<h2>Use cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h2>
<p>The main use case for Core scheduling is mitigating the cross-HT vulnerabilities
with SMT enabled. There are other use cases where this feature could be used:</p>
<ul class="simple">
<li><p>Isolating tasks that needs a whole core: Examples include realtime tasks, tasks
that uses SIMD instructions etc.</p></li>
<li><p>Gang scheduling: Requirements for a group of tasks that needs to be scheduled
together could also be realized using core scheduling. One example is vCPUs of
a VM.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>